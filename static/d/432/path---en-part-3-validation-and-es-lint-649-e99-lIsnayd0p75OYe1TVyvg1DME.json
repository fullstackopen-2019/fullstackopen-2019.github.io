{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>There are usually constraints that we want to apply to the data that is stored in our application's database. Our application shouldn't accept notes that have a missing or empty <i>content</i> property. The validity of the note is checked in the route handler:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>If the note does not have the <i>content</i> property, we respond to the request with the status code <i>400 bad request</i>.</p>\n<p>One smarter way of validating the format of the data before it is stored in the database, is to use the <a href=\"https://mongoosejs.com/docs/validation.html\">validation</a> functionality available in Mongoose.</p>\n<p>We can define specific validation rules for each field in the schema:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  content<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    type<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    minlength<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    required<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  date<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> </span><span class=\"gatsby-highlight-code-line\">    type<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    required<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  important<span class=\"token punctuation\">:</span> Boolean\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <i>content</i> field is now required to be at least five characters long. The <i>date</i> field is set as required, meaning that it can not be missing. The same constraint is also implicitly applied to the <i>content</i> field, since the minimum length constraint by default requires the field to not be missing. We have not added any constraints to the <i>important</i> field, so its definition in the schema has not changed.</p>\n<p>The <i>minlength</i> and <i>required</i> validators are <a href=\"https://mongoosejs.com/docs/validation.html#built-in-validators\">built-in</a> and provided by Mongoose. The Mongoose <a href=\"https://mongoosejs.com/docs/validation.html#custom-validators\">custom validator</a> functionality allows us to create new validators, if none of the built-in ones cover our needs.</p>\n<p>If we try to store an object in the database that breaks one of the constraints, the operation will throw an exception. Let's change our handler for creating a new note so that it passes any potential exceptions to the error handler middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    content<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    date<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Let's expand the error handler to deal with these validation errors:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span> <span class=\"token operator\">&amp;&amp;</span> error<span class=\"token punctuation\">.</span>kind <span class=\"token operator\">==</span> <span class=\"token string\">'ObjectId'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'ValidationError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> error<span class=\"token punctuation\">.</span>message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When validating an object fails, we return the following default error message from Mongoose:</p>\n<picture><img src=\"/static/6beb35ed56d2e06e0eda3e36dea9f426/14be6/50.png\" srcset=\"/static/6beb35ed56d2e06e0eda3e36dea9f426/4cce7/50.png 200w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/bae5f/50.png 400w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/14be6/50.png 800w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/1b35a/50.png 1200w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/9ee03/50.png 1600w,\n/static/6beb35ed56d2e06e0eda3e36dea9f426/d2375/50.png 1670w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Promise chaining</h3>\n<p>Many of the route handlers changed the response data into the right format by calling the <em>toJSON</em> method. When we created a new note, the <em>toJSON</em> method was called for the object passed as a parameter to <em>then</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We can accomplish the same functionality in a much cleaner way with <a href=\"https://javascript.info/promise-chaining\">promise chaining</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  note\n    <span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedAndFormattedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedAndFormattedNote<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> </span>    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In the first <em>then</em> we receive <em>savedNote</em> object returned by Mongoose and format it. The result of the operation is returned. Then as <a href=\"/en/part2/altering_data_in_server#extracting-communication-with-the-backend-into-a-separate-module\">we discussed earlier</a>, the <em>then</em> method of a promise also returns a promise. This means that when we return <em>savedNote.toJSON()</em> from the callback function, we are actually creating a promise that receives the formatted note as its value. We can access the formatted note by registering a new callback function with the <em>then</em> method.</p>\n<p>We can clean up our code even more by using the more compact syntax for arrow functions:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  note\n    <span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedNote <span class=\"token operator\">=></span> savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedAndFormattedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedAndFormattedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this example, Promise chaining does not provide much of a benefit. The situation would change if there were many asynchronous operations that had to be done in sequence. We will not delve further into the topic. In the next part of the course we will learn about the <i>async/await</i> syntax in JavaScript, that will make writing subsequent asynchronous operations a lot easier.</p>\n<h3>Deploying the database backend to production</h3>\n<p>The application should work almost as-is in Heroku. We do have to generate a new production build of the frontend due to the changes that we have made to our frontend. </p>\n<p>The environment variables defined in dotenv will only be used when the backend is not in <i>production mode</i>, i.e. Heroku.</p>\n<p>We defined the environment variables for development in file <i>.env</i>, but the environment variable that defines the database URL in production should be set to Heroku with the <em>heroku config:set</em> command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">heroku config:set MONGODB_URI<span class=\"token operator\">=</span>mongodb+srv://fullstack:secred@cluster0-ostce.mongodb.net/note-app?retryWrites<span class=\"token operator\">=</span>true</code></pre></div>\n<p>The application should now work. Sometimes things don't go according to plan. If there are problems, <i>heroku logs</i> will be there to help. My own application did not work after making the changes. The logs showed the following:</p>\n<picture><img src=\"/static/73865480c799fbb73e1d47004e297d8a/14be6/51a.png\" srcset=\"/static/73865480c799fbb73e1d47004e297d8a/4cce7/51a.png 200w,\n/static/73865480c799fbb73e1d47004e297d8a/bae5f/51a.png 400w,\n/static/73865480c799fbb73e1d47004e297d8a/14be6/51a.png 800w,\n/static/73865480c799fbb73e1d47004e297d8a/1b35a/51a.png 1200w,\n/static/73865480c799fbb73e1d47004e297d8a/9ee03/51a.png 1600w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>For some reason the URL of the database was undefined. The <i>heroku config</i> command revealed that I had accidentally defined the URL to the <em>MONGO_URL</em> environment variable, when the code expected it to be in <em>MONGODB_URI</em>.</p>\n<p>You can find the code for our current application in its entirety in the <i>part3-5</i> branch of <a href=\"https://github.com/fullstack-hy2019/part3-notes-backend/tree/part3-5\">this github repository</a>.</p>\n</div>\n</div>\n<div class=\"tasks\">\n<h3>Exercises</h3>\n<h4>3.19: Phonebook database, step7</h4>\n<p>Add validation to your application, that will make sure that you can only add one number for a person in the phonebook. Our current frontend won't allow users to try and create duplicates, but we can attempt to create them directly with Postman or the VS Code REST client.</p>\n<p>Mongoose does not offer a built-in validator for this purpose. Install the <a href=\"https://github.com/blakehaswell/mongoose-unique-validator#readme\">mongoose-unique-validator</a> package with npm and use it instead.</p>\n<p>If an HTTP POST request tries to add a name that is already in the phonebook, the server must respond with an appropriate status code and error message.</p>\n<h4>3.20*: Phonebook database, step8</h4>\n<p>Expand the validation so that the name stored in the database has to be at least three characters long, and the phone number must have at least 8 digits.</p>\n<p>Expand the frontend so that it displays some form of error message when a validation error occurs. Error handling can be implemented by adding a <em>catch</em> block as shown below:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">personService\n    <span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>createdPerson <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// this is the way to access the error message</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>You can display the default error message returned by Mongoose, even though they are not as readable as they could be:</p>\n<picture><img src=\"/static/fddf847e340f060549c3029f464a5493/14be6/56e.png\" srcset=\"/static/fddf847e340f060549c3029f464a5493/4cce7/56e.png 200w,\n/static/fddf847e340f060549c3029f464a5493/bae5f/56e.png 400w,\n/static/fddf847e340f060549c3029f464a5493/14be6/56e.png 800w,\n/static/fddf847e340f060549c3029f464a5493/1b35a/56e.png 1200w,\n/static/fddf847e340f060549c3029f464a5493/9ee03/56e.png 1600w,\n/static/fddf847e340f060549c3029f464a5493/60954/56e.png 1766w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>3.21 Deploying the database backend to production</h4>\n<p>Generate a new \"full stack\" version of the application by creating a new production build of the frontend, and copy it to the backend repository. Verify that everything works locally by using the entire application from the address <a href=\"https://localhost:3001\">https://localhost:3001</a>.</p>\n<p>Push the latest version to Heroku and verify that everything works there as well.</p>\n</div>\n<div class=\"content\">\n<h3>Lint</h3>\n<p>Before we move onto the next part, we will take a look at an important tool called <a href=\"https://en.wikipedia.org/wiki/Lint_(software)\">lint</a>. Wikipedia says the following about lint:</p>\n<blockquote>\n<p><i>Generically, lint or a linter is any tool that detects and flags errors in programming languages, including stylistic errors. The term lint-like behavior is sometimes applied to the process of flagging suspicious language usage. Lint-like tools generally perform static analysis of source code.</i></p>\n</blockquote>\n<p>In compiled statically typed languages like Java, IDEs like NetBeans can point out errors in the code, even ones that are more than just compile errors. Additional tools for performing <a href=\"https://en.wikipedia.org/wiki/Static_program_analysis\">static analysis</a> like <a href=\"http://checkstyle.sourceforge.net/\">checkstyle</a>, can be used for expanding the capabilities of the IDE to also point out problems related to style, like indentation.</p>\n<p>In the JavaScript universe, the current leading tool for static analysis aka. \"linting\" is <a href=\"https://eslint.org/\">ESlint</a>.</p>\n<p>Let's install ESlint as a development dependency to the backend project with the command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> eslint --save-dev</code></pre></div>\n<p>After this we can initialize a default ESlint configuration with the command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node_modules/.bin/eslint --init</code></pre></div>\n<p>We will answer all of the questions:</p>\n<picture><img src=\"/static/4816a38c32b5e579d4b0f332fc6171b7/14be6/52ae.png\" srcset=\"/static/4816a38c32b5e579d4b0f332fc6171b7/4cce7/52ae.png 200w,\n/static/4816a38c32b5e579d4b0f332fc6171b7/bae5f/52ae.png 400w,\n/static/4816a38c32b5e579d4b0f332fc6171b7/14be6/52ae.png 800w,\n/static/4816a38c32b5e579d4b0f332fc6171b7/1b35a/52ae.png 1200w,\n/static/4816a38c32b5e579d4b0f332fc6171b7/848c6/52ae.png 1254w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>The configuration will be saved in the <em>.eslintrc.js</em> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'env'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'commonjs'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'es6'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'node'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'extends'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'eslint:recommended'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'globals'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'Atomics'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'readonly'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'SharedArrayBuffer'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'readonly'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'parserOptions'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'ecmaVersion'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2018</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'rules'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'indent'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token number\">4</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'linebreak-style'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'unix'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'quotes'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'single'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'semi'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'never'</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let's immediately change the rule concerning indentation, so that the indentation level is two spaces.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">\"indent\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">2</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Inspecting and validating a file like <em>index.js</em> can be done with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node_modules/.bin/eslint index.js</code></pre></div>\n<p>It is recommended to create a separate <em>npm script</em> for linting:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  // ...\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node index.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"watch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon index.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eslint .\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  // ...\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now the <em>npm run lint</em> command will check every file in the project.</p>\n<p>Also the files in the <em>build</em> directory get checked when the command is run. We do not want this to happen, and we can accomplish this by creating an <a href=\"https://eslint.org/docs/user-guide/configuring#ignoring-files-and-directories\">.eslintignore</a> file in the project's root with the following contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">build</code></pre></div>\n<p>This causes the entire <em>build</em> directory to not be checked by ESlint.</p>\n<p>Lint has quite a lot to say about our code:</p>\n<picture><img src=\"/static/bb77853be1cc49fcecf1ff17b7ae3f2b/14be6/53e.png\" srcset=\"/static/bb77853be1cc49fcecf1ff17b7ae3f2b/4cce7/53e.png 200w,\n/static/bb77853be1cc49fcecf1ff17b7ae3f2b/bae5f/53e.png 400w,\n/static/bb77853be1cc49fcecf1ff17b7ae3f2b/14be6/53e.png 800w,\n/static/bb77853be1cc49fcecf1ff17b7ae3f2b/05938/53e.png 1146w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Let's not fix these issues just yet.</p>\n<p>A better alternative to executing the linter from the command line is to configure a <em>lint plugin</em> to the editor, that runs the linter continuously. By using the plugin you will see errors in your code immediately. You can find more information about the Visual Studio ESLint plugin <a href=\"https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint\">here</a>.</p>\n<p>The VS Code ESlint plugin will underline style violations with a red line:</p>\n<picture><img src=\"/static/64cf2fbae36000083aa1e48292aed8f2/14be6/54a.png\" srcset=\"/static/64cf2fbae36000083aa1e48292aed8f2/4cce7/54a.png 200w,\n/static/64cf2fbae36000083aa1e48292aed8f2/bae5f/54a.png 400w,\n/static/64cf2fbae36000083aa1e48292aed8f2/14be6/54a.png 800w,\n/static/64cf2fbae36000083aa1e48292aed8f2/1b35a/54a.png 1200w,\n/static/64cf2fbae36000083aa1e48292aed8f2/9ee03/54a.png 1600w,\n/static/64cf2fbae36000083aa1e48292aed8f2/bdfce/54a.png 1932w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>This makes errors easy to spot and fix right away.</p>\n<p>ESlint has a vast array of <a href=\"https://eslint.org/docs/rules/\">rules</a> that are easy to take into use by editing the <i>.eslintrc.js</i> file.</p>\n<p>Let's add the <a href=\"https://eslint.org/docs/rules/eqeqeq\">eqeqeq</a> rule that warns us, if equality is checked with anything but the the triple equals operator. The rule is added under the <i>rules</i> field in the configuration file.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  // ...\n  <span class=\"token property\">\"rules\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    // ...\n    <span class=\"token property\">\"eqeqeq\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"error\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>While we're at it, let's make a few other changes to the rules.</p>\n<p>Let's prevent unnecessary <a href=\"https://eslint.org/docs/rules/no-trailing-spaces\">trailing spaces</a> at the ends of lines, let's require that <a href=\"https://eslint.org/docs/rules/object-curly-spacing\">there is always a space before and after curly braces</a>, and let's also demand a consistent use of whitespaces in the function parameters of arrow functions.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  // ...\n  <span class=\"token property\">\"rules\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    // ...\n    <span class=\"token property\">\"eqeqeq\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"no-trailing-spaces\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"object-curly-spacing\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"always\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"arrow-spacing\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"before\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"after\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Our default configuration takes a bunch of predetermined rules into use from <i>eslint:recommended</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token string\">\"extends\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"eslint:recommended\"</span>,</code></pre></div>\n<p>This includes a rule that warns about <em>console.log</em> commands. <a href=\"https://eslint.org/docs/user-guide/configuring#configuring-rules\">Disabling</a> a rule can be accomplished by defining its \"value\" as 0 in the configuration file. Let's do this for the <i>no-console</i> rule in the meantime.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  // ...\n  <span class=\"token property\">\"rules\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    // ...\n    <span class=\"token property\">\"eqeqeq\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"no-trailing-spaces\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"object-curly-spacing\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"always\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"arrow-spacing\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"before\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"after\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"no-console\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>NB</strong> when you make changes to the <i>.eslintrc.js</i> file, it is recommended to run the linter from the command line. This will verify that the configuration file is correctly formatted:</p>\n<picture><img src=\"/static/683365a382c607616d65e603f8d8d39a/14be6/55.png\" srcset=\"/static/683365a382c607616d65e603f8d8d39a/4cce7/55.png 200w,\n/static/683365a382c607616d65e603f8d8d39a/bae5f/55.png 400w,\n/static/683365a382c607616d65e603f8d8d39a/14be6/55.png 800w,\n/static/683365a382c607616d65e603f8d8d39a/1b35a/55.png 1200w,\n/static/683365a382c607616d65e603f8d8d39a/9ee03/55.png 1600w,\n/static/683365a382c607616d65e603f8d8d39a/67c6f/55.png 1608w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>If there is something wrong in your configuration file, the lint plugin can behave quite erratically.</p>\n<p>Many companies define coding standards that are enforced throughout the organization through the ESlint configuration file. It is not recommended to keep reinventing the wheel over and over again, and it can be a good idea to adopt a ready-made configuration from someone else's project into yours. Recently many projects have adopted the Airbnb <a href=\"https://github.com/airbnb/javascript\">Javascript style guide</a> by taking Airbnb's <a href=\"https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb\">ESlint</a> configuration into use.</p>\n<p>You can find the code for our current application in its entirety in the <i>part3-6</i> branch of <a href=\"https://github.com/fullstackopen-2019/part3-notes-backend/tree/part3-6\">this github repository</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercises</h3>\n<h4>3.22: Lint configuration</h4>\n<p>Add ESlint to your application.</p>\n<p>This was the last exercise of this part of the course. It's time to push your code to GitHub and mark all of your finished exercises to the <a href=\"https://studies.cs.helsinki.fi/fullstackopen2019\">exercise submission system</a>.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/part-3-8ac7bc0fb2b7018a7853b00c454b2103.svg"},"part":3,"letter":"d","lang":"en"}}},"pageContext":{"part":3,"letter":"d","lang":"en"}}
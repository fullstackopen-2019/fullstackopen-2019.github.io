{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Ennen kuin siirrymme osan varsinaiseen aiheeseen, eli tiedon tallettamiseen tietokantaan, tarkastellaan muutamaa tapaa Node-sovellusten debuggaamiseen.</p>\n<h3>Node-sovellusten debuggaaminen</h3>\n<p>Nodella tehtyjen sovellusten debuggaaminen on jossain määrin hankalampaa kuin selaimessa toimivan Javascriptin. Vanha hyvä keino on tietysti konsoliin tulostelu. Se kannattaa aina. On mielipiteitä, joiden mukaan konsoliin tulostelun sijaan olisi syytä suosia jotain kehittyneempää menetelmää, mutta en ole ollenkaan samaa mieltä. Jopa maailman aivan eliittiin kuuluvat open source -kehittäjät <a href=\"https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html\">käyttävät</a> tätä <a href=\"https://swizec.com/blog/javascript-debugging-slightly-beyond-console-log/swizec/6633\">menetelmää</a>.</p>\n<h4>Visual Studio Code</h4>\n<p>Visual Studio Coden debuggeri voi olla hyödyksi joissain tapauksissa. Saat käynnistettyä sovelluksen debuggaustilassa seuraavasti</p>\n<picture><img src=\"/static/d5be104ee40f9e3c2793b288c15d50dc/14be6/35.png\" srcset=\"/static/d5be104ee40f9e3c2793b288c15d50dc/4cce7/35.png 200w,\n/static/d5be104ee40f9e3c2793b288c15d50dc/bae5f/35.png 400w,\n/static/d5be104ee40f9e3c2793b288c15d50dc/14be6/35.png 800w,\n/static/d5be104ee40f9e3c2793b288c15d50dc/1b35a/35.png 1200w,\n/static/d5be104ee40f9e3c2793b288c15d50dc/9ee03/35.png 1600w,\n/static/d5be104ee40f9e3c2793b288c15d50dc/b6ad2/35.png 1880w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Huomaa, että sovellus ei saa olla samalla käynnissä \"normaalisti\" konsolista, sillä tällöin sovelluksen käyttämä portti on varattu.</p>\n<p>Seuraavassa screenshot, missä koodi on pysäytetty kesken uuden muistiinpanon lisäyksen</p>\n<picture><img src=\"/static/47274d6ad3595488a2525b0392c87765/14be6/36a.png\" srcset=\"/static/47274d6ad3595488a2525b0392c87765/4cce7/36a.png 200w,\n/static/47274d6ad3595488a2525b0392c87765/bae5f/36a.png 400w,\n/static/47274d6ad3595488a2525b0392c87765/14be6/36a.png 800w,\n/static/47274d6ad3595488a2525b0392c87765/1b35a/36a.png 1200w,\n/static/47274d6ad3595488a2525b0392c87765/9ee03/36a.png 1600w,\n/static/47274d6ad3595488a2525b0392c87765/22997/36a.png 2040w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Koodi on pysähtynyt nuolen osoittaman <i>breakpointin</i> kohdalle ja konsoliin on evaluoitu muuttujan <i>note</i> arvo. Vasemmalla olevassa ikkunassa on nähtävillä myös muuta ohjelman tilaan liittyvää.</p>\n<p>Ylhäällä olevista nuolista yms. voidaan kontrolloida debuggauksen etenemistä.</p>\n<p>Itse en jostain syystä juurikaan käytä Visual Studio Coden debuggeria.</p>\n<h4>Chromen dev tools</h4>\n<p>Debuggaus onnisuu myös Chromen developer-konsolilla, käynnistämällä sovellus komennolla:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node --inspect index.js</code></pre></div>\n<p>Debuggeriin pääsee käsiksi klikkaamalla chromen devloper-konsoliin ilmestyneestä vihreästä ikonista</p>\n<picture><img src=\"/static/98eea9ee4f184a484417314745f7422a/14be6/37.png\" srcset=\"/static/98eea9ee4f184a484417314745f7422a/4cce7/37.png 200w,\n/static/98eea9ee4f184a484417314745f7422a/bae5f/37.png 400w,\n/static/98eea9ee4f184a484417314745f7422a/14be6/37.png 800w,\n/static/98eea9ee4f184a484417314745f7422a/1b35a/37.png 1200w,\n/static/98eea9ee4f184a484417314745f7422a/9ee03/37.png 1600w,\n/static/98eea9ee4f184a484417314745f7422a/5e830/37.png 1688w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Debuggausnäkymä toimii kuten React-koodia debugattaessa, <i>Sources</i>-välilehdelle voidaan esim. asettaa breakpointeja, eli kohtia joihin suoritus pysähtyy:</p>\n<picture><img src=\"/static/b281c335030ebb38e485565e0add8735/14be6/38e.png\" srcset=\"/static/b281c335030ebb38e485565e0add8735/4cce7/38e.png 200w,\n/static/b281c335030ebb38e485565e0add8735/bae5f/38e.png 400w,\n/static/b281c335030ebb38e485565e0add8735/14be6/38e.png 800w,\n/static/b281c335030ebb38e485565e0add8735/1b35a/38e.png 1200w,\n/static/b281c335030ebb38e485565e0add8735/9ee03/38e.png 1600w,\n/static/b281c335030ebb38e485565e0add8735/65610/38e.png 1950w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Huomaa, että tällä hetkellä eräs debuggeriin liittyvä <a href=\"https://github.com/nodejs/node/issues/23693\">bugi</a> aiheuttaa sen, että breakpointit toimivat ainoastaan jos koodissa käytetään koodin pysäyttävää <em>debugger</em>-komentoa. </p>\n<p>Kaikki sovelluksen console.log-tulostukset tulevat debuggerin <i>Console</i>-välilehdelle. Voit myös tutkia siellä muuttujien arvoja ja suorittaa mielivaltaista Javascript-koodia:</p>\n<picture><img src=\"/static/3873ec3085afa0d3650fb850f2ce1960/14be6/39e.png\" srcset=\"/static/3873ec3085afa0d3650fb850f2ce1960/4cce7/39e.png 200w,\n/static/3873ec3085afa0d3650fb850f2ce1960/bae5f/39e.png 400w,\n/static/3873ec3085afa0d3650fb850f2ce1960/14be6/39e.png 800w,\n/static/3873ec3085afa0d3650fb850f2ce1960/1b35a/39e.png 1200w,\n/static/3873ec3085afa0d3650fb850f2ce1960/9ee03/39e.png 1600w,\n/static/3873ec3085afa0d3650fb850f2ce1960/72edd/39e.png 1734w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>Epäile kaikkea</h4>\n<p>Full Stack -sovellusten debuggaaminen vaikuttaa alussa erittäin hankalalta. Kun kohta kuvaan tulee myös tietokanta ja frontend on yhdistetty backendiin, on potentiaalisia virhelähteitä todella paljon.</p>\n<p>Kun sovellus \"ei toimi\", onkin selvitettävä missä vika on. On erittäin yleistä, että vika on sellaisessa paikassa, mitä ei osaa ollenkaan epäillä, ja menee minuutti-, tunti- tai jopa päiväkausia ennen kuin oikea ongelmien lähde löytyy.</p>\n<p>Avainasemassa onkin systemaattisuus. Koska virhe voi olla melkein missä vain, <i>kaikkea pitää epäillä</i>, ja tulee pyrkiä poissulkemaan ne osat tarkastelusta, missä virhe ei ainakaan ole. Konsoliin kirjoitus, Postman, debuggeri ja kokemus auttavat.</p>\n<p>Virheiden ilmaantuessa <i>ylivoimaisesti huonoin strategia</i> on jatkaa koodin kirjoittamista. Se on tae siitä, että koodissa on pian kymmenen ongelmaa lisää ja niiden syyn selvittäminen on entistäkin vaikeampaa. Toyota Production Systemin periaate <a href=\"http://gettingtolean.com/toyota-principle-5-build-culture-stopping-fix/#.Wjv9axP1WCQ\">Stop and fix</a> toimii tässäkin yhteydessä paremmin kuin hyvin.</p>\n<h3>MongoDB</h3>\n<p>Jotta saisimme talletettua muistiinpanot pysyvästi, tarvitsemme tietokannan. Useimmilla laitoksen kursseilla on käytetty relaatiotietokantoja. Tällä kurssilla käytämme <a href=\"https://www.mongodb.com/\">MongoDB</a>:tä, joka on ns. <a href=\"https://en.wikipedia.org/wiki/Document-oriented_database\">dokumenttitietokanta</a>.</p>\n<p>Dokumenttitietokannat poikkeavat jossain määrin relaatiotietokannoista niin datan organisointitapansa kuin kyselykielensäkin suhteen. Dokumenttitietokantojen ajatellaan kuuluvan sateenvarjotermin <a href=\"https://en.wikipedia.org/wiki/NoSQL\">NoSQL</a> alle. Lisää dokumenttitietokannoista ja NoSQL:stä Tietokantojen perusteiden <a href=\"https://tikape-s18.mooc.fi/part7/\">viikon 7 materiaalista</a>.</p>\n<p><strong>Lue nyt Tietokantojen perusteiden dokumenttitietokantoja kuvaava osuus.</strong> Jatkossa oletetaan, että hallitset käsitteet <i>dokumentti</i> ja <i>kokoelma</i> (collection).</p>\n<p>MongoDB:n voi luonnollisesti asentaa omalle koneelle. Internetistä löytyy kuitenkin myös palveluna toimivia Mongoja, joista tämän hetken paras valinta on <a href=\"https://www.mongodb.com/cloud/atlas\">MongoDB Atlas</a>.</p>\n<p>Kun käyttäjätili on luotu ja kirjauduttu, Atlas kehoittaa luomaan klusterin:</p>\n<picture><img src=\"/static/eb76cc9c7abe028a28fd91fddac12466/14be6/57.png\" srcset=\"/static/eb76cc9c7abe028a28fd91fddac12466/4cce7/57.png 200w,\n/static/eb76cc9c7abe028a28fd91fddac12466/bae5f/57.png 400w,\n/static/eb76cc9c7abe028a28fd91fddac12466/14be6/57.png 800w,\n/static/eb76cc9c7abe028a28fd91fddac12466/1b35a/57.png 1200w,\n/static/eb76cc9c7abe028a28fd91fddac12466/9ee03/57.png 1600w,\n/static/eb76cc9c7abe028a28fd91fddac12466/8003f/57.png 1836w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Valitaan <i>AWS</i> ja <i>Frankfurt</i> ja luodaan klusteri.</p>\n<picture><img src=\"/static/517709f56808d0b57ebd9a974a1af519/14be6/58.png\" srcset=\"/static/517709f56808d0b57ebd9a974a1af519/4cce7/58.png 200w,\n/static/517709f56808d0b57ebd9a974a1af519/bae5f/58.png 400w,\n/static/517709f56808d0b57ebd9a974a1af519/14be6/58.png 800w,\n/static/517709f56808d0b57ebd9a974a1af519/1b35a/58.png 1200w,\n/static/517709f56808d0b57ebd9a974a1af519/9ee03/58.png 1600w,\n/static/517709f56808d0b57ebd9a974a1af519/15613/58.png 1710w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Odotetaan että klusteri on valmiina, tähän menee noin 10 minuuttia. </p>\n<p><strong>HUOM</strong> älä jatka eteenpäin ennen kun klusteri on valmis!</p>\n<p>Luodaan <i>security</i> välilehdeltä tietokantakäyttäjätunnus joka on siis eri tunnus kuin se, jonka avulla kirjaudutaan MongoDB Atlasiin:</p>\n<picture><img src=\"/static/b9787b3e950ae3acdd6e8c24b6c41597/14be6/59.png\" srcset=\"/static/b9787b3e950ae3acdd6e8c24b6c41597/4cce7/59.png 200w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/bae5f/59.png 400w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/14be6/59.png 800w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/1b35a/59.png 1200w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/9ee03/59.png 1600w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/217e0/59.png 2400w,\n/static/b9787b3e950ae3acdd6e8c24b6c41597/4c7ad/59.png 2549w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>annetaan käyttäjälle luku- ja kirjoitustoikeus kaikkiin tietokantoihin</p>\n<picture><img src=\"/static/df119e4306c0102df432e1d9d75ba285/14be6/60.png\" srcset=\"/static/df119e4306c0102df432e1d9d75ba285/4cce7/60.png 200w,\n/static/df119e4306c0102df432e1d9d75ba285/bae5f/60.png 400w,\n/static/df119e4306c0102df432e1d9d75ba285/14be6/60.png 800w,\n/static/df119e4306c0102df432e1d9d75ba285/1b35a/60.png 1200w,\n/static/df119e4306c0102df432e1d9d75ba285/b1255/60.png 1526w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p><strong>HUOM</strong> muutamissa tapauksissa uusi käyttäjä ei ole toiminut heti luomisen jälkeen. On saattanut kestää jopa useita minuutteja ennen kuin käyttäjätunnus on ruvennut toimimaan.</p>\n<p>Seuraavaksi tulee määritellä ne ip-osoitteet, joista tietokantaan pääsee käsiksi</p>\n<picture><img src=\"/static/6bd9e7d3140b9262d9919a451125daaf/14be6/61.png\" srcset=\"/static/6bd9e7d3140b9262d9919a451125daaf/4cce7/61.png 200w,\n/static/6bd9e7d3140b9262d9919a451125daaf/bae5f/61.png 400w,\n/static/6bd9e7d3140b9262d9919a451125daaf/14be6/61.png 800w,\n/static/6bd9e7d3140b9262d9919a451125daaf/1b35a/61.png 1200w,\n/static/6bd9e7d3140b9262d9919a451125daaf/9ee03/61.png 1600w,\n/static/6bd9e7d3140b9262d9919a451125daaf/676a5/61.png 1828w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Sallitaan yksinkertaisuuden vuoksi yhteydet kaikkialta:</p>\n<picture><img src=\"/static/6eb9d9ccbbd931b09258a5b6944da209/14be6/62.png\" srcset=\"/static/6eb9d9ccbbd931b09258a5b6944da209/4cce7/62.png 200w,\n/static/6eb9d9ccbbd931b09258a5b6944da209/bae5f/62.png 400w,\n/static/6eb9d9ccbbd931b09258a5b6944da209/14be6/62.png 800w,\n/static/6eb9d9ccbbd931b09258a5b6944da209/1b35a/62.png 1200w,\n/static/6eb9d9ccbbd931b09258a5b6944da209/599db/62.png 1354w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Lopultakin ollaan valmiina ottamaan tietokantayhteyden. Valitaan <i>Connect your application</i> ja <i>Short SRV connection string</i></p>\n<picture><img src=\"/static/6111c05c94c5b33e618c47dc1b6048e4/14be6/64.png\" srcset=\"/static/6111c05c94c5b33e618c47dc1b6048e4/4cce7/64.png 200w,\n/static/6111c05c94c5b33e618c47dc1b6048e4/bae5f/64.png 400w,\n/static/6111c05c94c5b33e618c47dc1b6048e4/14be6/64.png 800w,\n/static/6111c05c94c5b33e618c47dc1b6048e4/1b35a/64.png 1200w,\n/static/6111c05c94c5b33e618c47dc1b6048e4/07092/64.png 1336w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Näkymä kertoo <i>MongoDB URI:n</i> eli osoitteen, jonka avulla sovelluksemme käyttämä MongoDB-kirjasto saa yhteyden kantaan.</p>\n<p>Osoite näyttää seuraavalta:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mongodb+srv://fullstack:<span class=\"token operator\">&lt;</span>PASSWORD<span class=\"token operator\">></span>@cluster0-ostce.mongodb.net/test?retryWrites<span class=\"token operator\">=</span>true</code></pre></div>\n<p>Olemme nyt valmiina kannan käyttöön.</p>\n<p>Voisimme käyttää kantaa Javascript-koodista suoraan Mongon virallisen\n<a href=\"https://mongodb.github.io/node-mongodb-native/\">MongoDB Node.js driver</a> -kirjaston avulla, mutta se on ikävän työlästä. Käytämmekin hieman korkeammalla tasolla toimivaa <a href=\"http://mongoosejs.com/index.html\">Mongoose</a>-kirjastoa.</p>\n<p>Mongoosesta voisi käyttää luonnehdintaa <i>object document mapper</i> (ODM), ja sen avulla Javascript-olioiden tallettaminen mongon dokumenteiksi on suoraviivaista.</p>\n<p>Asennetaan Mongoose:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> mongoose --save</code></pre></div>\n<p>Ei lisätä mongoa käsittelevää koodia heti backendin koodin sekaan, vaan tehdään erillinen kokeilusovellus tiedostoon <i>mongo.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span>length<span class=\"token operator\">&lt;</span><span class=\"token number\">3</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'give password as argument'</span><span class=\"token punctuation\">)</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token string\">`mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0-ostce.mongodb.net/test?retryWrites=true`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useNewUrlParser<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnote<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Koodi siis olettaa, että sille annetaan parametrina MongoDB Atlasissa luodulle käyttäjälle määritelty salasana. Komentoriviparametriin se pääsee käsiksi seuraavasti</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Kun koodi suoritetaan komennolla <i>node mongo.js salasana</i> lisää Mongoose tietokantaan uuden dokumentin.</p>\n<p>Voimme tarkastella tietokannan tilaa MongoDB Atlasin hallintanäkymän <i>collections</i>-osasta</p>\n<picture><img src=\"/static/2bc891f00389ca52ace786300bcba3e0/14be6/65.png\" srcset=\"/static/2bc891f00389ca52ace786300bcba3e0/4cce7/65.png 200w,\n/static/2bc891f00389ca52ace786300bcba3e0/bae5f/65.png 400w,\n/static/2bc891f00389ca52ace786300bcba3e0/14be6/65.png 800w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Kuten näkymä kertoo, on muistiinpanoa vastaava <i>dokumentti</i> lisätty tietokannan <i>test</i> kokoelmaan (collection) nimeltään <i>notes</i>.</p>\n<picture><img src=\"/static/be8ce275e0c31d665c14ee59c657672a/14be6/66a.png\" srcset=\"/static/be8ce275e0c31d665c14ee59c657672a/4cce7/66a.png 200w,\n/static/be8ce275e0c31d665c14ee59c657672a/bae5f/66a.png 400w,\n/static/be8ce275e0c31d665c14ee59c657672a/14be6/66a.png 800w,\n/static/be8ce275e0c31d665c14ee59c657672a/1b35a/66a.png 1200w,\n/static/be8ce275e0c31d665c14ee59c657672a/9ee03/66a.png 1600w,\n/static/be8ce275e0c31d665c14ee59c657672a/5f1e0/66a.png 1844w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Tietokanta lienee loogisempaa nimetä paremmin. Kuten dokumentaatio sanoo, kontrolloidaan kannan nimeä tietokanta-URI:in perusteella</p>\n<picture><img src=\"/static/beff6ba27a1ca87c562b394397f2c6a3/14be6/67.png\" srcset=\"/static/beff6ba27a1ca87c562b394397f2c6a3/4cce7/67.png 200w,\n/static/beff6ba27a1ca87c562b394397f2c6a3/bae5f/67.png 400w,\n/static/beff6ba27a1ca87c562b394397f2c6a3/14be6/67.png 800w,\n/static/beff6ba27a1ca87c562b394397f2c6a3/1b35a/67.png 1200w,\n/static/beff6ba27a1ca87c562b394397f2c6a3/e4c37/67.png 1370w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>eli tuhotaan kanta <i>test</i>. Päätetään käyttää tietokannasta nimeä <i>note-app</i> muutetaan siis tietokanta-URI muotoon</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mongodb+srv://fullstack:<span class=\"token operator\">&lt;</span>PASSWORD<span class=\"token operator\">></span>@cluster0-ostce.mongodb.net/note-app?retryWrites<span class=\"token operator\">=</span>true</code></pre></div>\n<p>Suoritetaan ohjelma uudelleen.</p>\n<picture><img src=\"/static/4a616d96982f5bf8a940d87fcd4549cd/14be6/68.png\" srcset=\"/static/4a616d96982f5bf8a940d87fcd4549cd/4cce7/68.png 200w,\n/static/4a616d96982f5bf8a940d87fcd4549cd/bae5f/68.png 400w,\n/static/4a616d96982f5bf8a940d87fcd4549cd/14be6/68.png 800w,\n/static/4a616d96982f5bf8a940d87fcd4549cd/1b35a/68.png 1200w,\n/static/4a616d96982f5bf8a940d87fcd4549cd/9ee03/68.png 1600w,\n/static/4a616d96982f5bf8a940d87fcd4549cd/23f65/68.png 1834w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Data on nyt oikeassa kannassa. Hallintanäkymä sisältää myös toiminnon <i>create database</i>, joka mahdollistaa uusien tietokantojenluomisen hallintanäkymän kautta. Kannan luominen etukäteen hallintanäkymässä ei kuitenkaan ole tarpeen, sillä MongoDB Atlas osaa luoda kannan automaattisesti, jos sovellus yrittää yhdistää kantaan, jota ei ole vielä olemassa.</p>\n<h3>Skeema</h3>\n<p>Yhteyden avaamisen jälkeen määritellään muistiinpanon <a href=\"http://mongoosejs.com/docs/guide.html\">skeema</a> ja sitä vastaava <a href=\"http://mongoosejs.com/docs/models.html\">model</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Ensin muuttujaan <em>noteSchema</em> määritellään muistiinpanon <a href=\"http://mongoosejs.com/docs/guide.html\">skeema</a>, joka kertoo Mongooselle, miten muistiinpano-oliot tulee tallettaa tietokantaan.</p>\n<p>Modelin <em>Note</em> määrittelyssä ensimmäisenä parametrina oleva merkkijono <i>Note</i> määrittelee, että mongoose tallettaa muistiinpanoa vastaavat oliot kokoelmaan nimeltään <i>notes</i>, sillä <a href=\"http://mongoosejs.com/docs/models.html\">Mongoosen konventiona</a> on määritellä kokoelmien nimet monikossa (esim. <i>notes</i>), kun niihin viitataan skeeman määrittelyssä yksikkömuodossa (esim. <i>Note</i>).</p>\n<p>Dokumenttikannat, kuten Mongo ovat <i>skeemattomia</i>, eli tietokanta itsessään ei välitä mitään sinne talletettavan tiedon muodosta. Samaan kokoelmaankin on mahdollista tallettaa olioita joilla on täysin eri kentät.</p>\n<p>Mongoosea käytettäessä periaatteena on kuitenkin se, että tietokantaan talletettavalle tiedolle määritellään <i>sovelluksen koodin tasolla skeema</i>, joka määrittelee minkä muotoisia olioita kannan eri kokoelmiin talletetaan.</p>\n<h3>Olioiden luominen ja tallettaminen</h3>\n<p>Seuraavaksi sovellus luo muistiinpanoa vastaavan <a href=\"http://mongoosejs.com/docs/models.html\">model</a>:in avulla muistiinpano-olion:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> <span class=\"token string\">'Browser can execute only Javascript'</span><span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Modelit ovat ns. <i>konstruktorifunktioita</i>, jotka luovat parametrien perusteella Javascript-olioita. Koska oliot on luotu modelien konstruktorifunktiolla, niillä on kaikki modelien ominaisuudet, eli joukko metodeja, joiden avulla olioita voidaan mm. tallettaa tietokantaan.</p>\n<p>Tallettaminen tapahtuu metodilla <em>save</em>. Metodi palauttaa <i>promisen</i>, jolle voidaan rekisteröidä <em>then</em>-metodin avulla tapahtumankäsittelijä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kun olio on tallennettu kantaan, kutsutaan <em>then</em>:in parametrina olevaa tapahtumankäsittelijää, joka sulkee tietokantayhteyden komennolla <code>mongoose.connection.close()</code>. Ilman yhteyden sulkemista ohjelman suoritus ei pääty.</p>\n<p>Tallennusoperaation tulos on takaisinkutsun parametrissa <em>result</em>. Yhtä olioa tallentaessamme tulos ei ole kovin mielenkiintoinen, olion sisällön voi esim. tulostaa konsoliin, jos haluaa tutkia sitä tarkemmin sovelluslogiikassa tai esim. debugatessa.</p>\n<p>Talletetaan kantaan myös pari muuta muistiinpanoa muokkaamalla dataa koodista ja suorittamalla ohjelma uudelleen.</p>\n<p><strong>HUOM.</strong> Valitettavasti Mongoosen dokumentaatiossa käytetään joka paikassa takaisinkutsufunktioita, joten sieltä ei kannata suoraan copypasteta koodia, sillä promisejen ja vanhanaikaisten callbackien sotkeminen samaan koodiin ei ole kovin järkevää.</p>\n<h3>Olioiden hakeminen tietokannasta</h3>\n<p>Kommentoidaan koodista uusia muistiinpanoja generoiva osa, ja korvataan se seuraavalla:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  result<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kun koodi suoritetaan, kantaan talletetut muistiinpanot tulostuvat.</p>\n<p>Oliot haetaan kannasta <em>Note</em>-modelin metodilla <a href=\"http://mongoosejs.com/docs/api.html#find_find\">find</a>. Metodin parametrina on hakuehto. Koska hakuehtona on tyhjä olio <code>{}</code>, saimme kannasta kaikki <em>notes</em>-kokoelmaan talletetut oliot.</p>\n<p>Hakuehdot noudattavat mongon <a href=\"https://docs.mongodb.com/manual/reference/operator/\">syntaksia</a>.</p>\n<p>Voisimme hakea esim. ainoastaan tärkeät muistiinpanot seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> important<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Tehtäviä</h3>\n<h4>3.12: tietokanta komentoriviltä</h4>\n<p>Luo puhelinluettelo-sovellukselle pilvessä oleva mongo Mongo DB Atlaksen avulla.</p>\n<p>Tee projektihakemistoon tiedosto <i>mongo.js</i>, jonka avulla voit lisätä tietokantaan puhelinnumeroja sekä listata kaikki kannassa olevat numerot.</p>\n<p><strong>HUOM.</strong> Jos/kun laitat tiedoston Githubiin, älä laita tietokannan salasanaa mukaan!</p>\n<p>Ohjelma toimii siten, että jos sille annetaan käynnistäessä kolme komentoriviparametria (joista ensimmäinen on salasana), esim:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node mongo.js yourpassword Anna 040-1234556</code></pre></div>\n<p>Ohjelma tulostaa</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">added Anna number 040-1234556 to phonebook</code></pre></div>\n<p>ja lisää uuden yhteystiedon tietokantaan. Huomaa, että jos nimi sisältää välilyöntejä, on se annettava hipsuissa:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node mongo.js yourpassword <span class=\"token string\">\"Arto Vihavainen\"</span> 040-1234556</code></pre></div>\n<p>Jos komentoriviparametreina ei ole muuta kuin salasana, eli ohjelma suoritetaan komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node mongo.js yourpassword</code></pre></div>\n<p>tulostaa ohjelma tietokannassa olevat numerotiedot:</p>\n<pre>\nphonebook:\nAnna 040-1234556\nArto Vihavainen 045-1232456\nAda Lovelace 040-1231236\n</pre>\n<p>Saat selville ohjelman komentoriviparametrit muuttujasta <a href=\"https://nodejs.org/docs/latest-v8.x/api/process.html#process_process_argv\">process.argv</a></p>\n<p><strong>HUOM. Älä sulje tietokantayhteyttä väärässä kohdassa</strong>. Esim. seuraava koodi ei toimi</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>persons<span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Koodin suoritus nimittäin etenee siten, että heti operaation <i>Person.find</i> käynnistymisen jälkeen suoritetaan komento <i>mongoose.connection.close()</i> ja tietokantayhteys katkeaa välittömästi. Näin ei koskaan päästä siihen pisteeseen, että <i>Person.find</i>-operaation valmistumisen käsittelevää <i>takaisinkutsufunktiota</i> kutsuttaisiin.</p>\n<p>Oikea paikka tietokantayhteyden sulkemiselle on takaisinkutsufunktion loppu:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>persons<span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>HUOM.</strong> Jos määrittelet modelin nimeksi <i>Person</i>, muuttaa mongoose sen monikkomuotoon <i>people</i>, jota se käyttää vastaavan kokoelman nimenä.</p>\n</div>\n<div class=\"content\">\n<h3>Tietokantaa käyttävä backend</h3>\n<p>Nyt meillä on periaatteessa hallussamme riittävä tietämys ottaa mongo käyttöön sovelluksessamme.</p>\n<p>Aloitetaan nopean kaavan mukaan, copypastetaan tiedostoon <i>index.js</i> Mongoosen määrittelyt, eli</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// ÄLÄ KOSKAAN TALLETA SALASANOJA githubiin!</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token string\">'mongodb+srv://fullstack:sekred@cluster0-ostce.mongodb.net/note-app?retryWrites=true'</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useNewUrlParser<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>ja muutetaan kaikkien muistiinpanojen hakemisesta vastaava käsittelijä seuraavaan muotoon</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>notes <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Voimme todeta selaimella, että backend toimii kaikkien dokumenttien näyttämisen osalta:</p>\n<picture><img src=\"/static/d96f3dc4e2aac580faf7750890d90b47/14be6/44e.png\" srcset=\"/static/d96f3dc4e2aac580faf7750890d90b47/4cce7/44e.png 200w,\n/static/d96f3dc4e2aac580faf7750890d90b47/bae5f/44e.png 400w,\n/static/d96f3dc4e2aac580faf7750890d90b47/14be6/44e.png 800w,\n/static/d96f3dc4e2aac580faf7750890d90b47/1b35a/44e.png 1200w,\n/static/d96f3dc4e2aac580faf7750890d90b47/60a0f/44e.png 1512w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Toiminnallisuus on muuten kunnossa, mutta frontend olettaa, että olioiden yksikäsitteinen tunniste on kentässä <i>id</i>. Emme myöskään halua näyttää frontendille mongon versiointiin käyttämää kenttää <i>__v</i>. </p>\n<p>Eräs tapa muotoilla Mongoosen palauttamat oliot haluttuun muotoon on <a href=\"https://stackoverflow.com/questions/7034848/mongodb-output-id-instead-of-id\">muokata</a> kannasta haettavilla olioilla olevan <em>toJSON</em>-metodin palauttamaa muotoa. Metodin muokkaus onnistuu seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">noteSchema<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  transform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> returnedObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Vaikka Mongoose-olioiden kenttä <i>_id</i> näyttääkin merkkijonolta, se on todellisuudessa olio. Määrittelemämme metodi <em>toJSON</em> muuttaa sen merkkijonoksi kaiken varalta. Jos emme tekisi muutosta, siitä aiheutuisi ylimääräistä harmia testien yhteydessä.</p>\n<p>Palautetaan HTTP-pyynnön vastauksena <em>toJSON</em>-metodin avulla muotoiltuja oliota:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>notes <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> note<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Nyt siis muuttujassa <em>notes</em> on taulukollinen mongon palauttamia olioita. Kun suoritamme operaation <em>notes.map(note => note.toJSON())</em> seurauksena on uusi taulukko, missä on jokaista alkuperäisen taulukon alkiota vastaava metodin <em>toJSON</em> avulla muodostettu alkio.</p>\n<h3>Tietokantamäärittelyjen eriyttäminen moduuliksi</h3>\n<p>Ennen kuin täydennämme backendin muutkin osat käyttämään tietokantaa, eriytetään Mongoose-spesifinen koodi omaan moduuliin.</p>\n<p>Tehdään moduulia varten hakemisto <i>models</i> ja sinne tiedosto <i>note.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span></span>\n<span class=\"gatsby-highlight-code-line\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span></span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useNewUrlParser<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  content<span class=\"token punctuation\">:</span> String<span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">,</span>\n  important<span class=\"token punctuation\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnoteSchema<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  transform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">,</span> returnedObject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></span></code></pre></div>\n<p>Noden <a href=\"https://nodejs.org/docs/latest-v8.x/api/modules.html\">moduulien</a> määrittely poikkeaa hiukan osassa 2 määrittelemistämme frontendin käyttämistä <a href=\"/osa2/kokoelmien_renderointi_ja_moduulit#refaktorointia-moduulit\">ES6-moduuleista</a>.</p>\n<p>Moduulin ulos näkyvä osa määritellään asettamalla arvo muuttujalle <em>module.exports</em>. Asetamme arvoksi modelin <i>Note</i>. Muut moduulin sisällä määritellyt asiat, esim. muuttujat <em>mongoose</em> ja <em>url</em> eivät näy moduulin käyttäjälle.</p>\n<p>Moduulin käyttöönotto tapahtuu lisäämällä tiedostoon <i>index.js</i> seuraava rivi</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Näin muuttuja <em>Note</em> saa arvokseen saman olion, jonka moduuli määrittelee.</p>\n<p>Yhteyden muodostustavassa on pieni muutos aiempaan:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useNewUrlParser<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Tietokannan osoitetta ei kannata kirjoittaa koodiin, joten osoite annetaan sovellukselle ympäristömuuttujan <em>MONGODB_URI</em> välityksellä. </p>\n<p>Yhteyden muodostavalle metodille on nyt rekisteröity onnistuneen ja epäonnistuneen yhteydenmuodostuksen käsittelevät funktiot, jotka tulostavat konsoliin tiedon siitä, onnistuuko yhteyden muodostaminen:</p>\n<picture><img src=\"/static/b7b715296b130693831cc719ea8d2f99/14be6/45e.png\" srcset=\"/static/b7b715296b130693831cc719ea8d2f99/4cce7/45e.png 200w,\n/static/b7b715296b130693831cc719ea8d2f99/bae5f/45e.png 400w,\n/static/b7b715296b130693831cc719ea8d2f99/14be6/45e.png 800w,\n/static/b7b715296b130693831cc719ea8d2f99/1b35a/45e.png 1200w,\n/static/b7b715296b130693831cc719ea8d2f99/09543/45e.png 1582w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>On useita tapoja määritellä ympäristömuuttujan arvo, voimme esim. antaa sen ohjelman käynnistyksen yhteydessä seuraavasti</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">MONGODB_URI<span class=\"token operator\">=</span>osoite_tahan <span class=\"token function\">npm</span> run <span class=\"token function\">watch</span></code></pre></div>\n<p>Eräs kehittyneempi tapa on käyttää <a href=\"https://github.com/motdotla/dotenv#readme\">dotenv</a>-kirjastoa. Asennetaan kirjasto komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> dotenv --save</code></pre></div>\n<p>Sovelluksen juurihakemistoon tehdään sitten tiedosto nimeltään <i>.env</i>, minne tarvittavien ympäristömuuttujien arvot määritellään. Tiedosto näyttää seuraavalta</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">MONGODB_URI<span class=\"token operator\">=</span>mongodb+srv://fullstack:sekred@cluster0-ostce.mongodb.net/note-app?retryWrites<span class=\"token operator\">=</span>true\nPORT<span class=\"token operator\">=</span>3001</code></pre></div>\n<p>Määrittelimme samalla aiemmin kovakoodaamamme sovelluksen käyttämän portin eli ympäristömuuttujan <em>PORT</em>.</p>\n<p><strong>Tiedosto <i>.env</i> tulee heti gitignorata, sillä emme halua julkaista tiedoston sisältöä verkkoon!</strong></p>\n<picture><img src=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/14be6/45ae.png\" srcset=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/4cce7/45ae.png 200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/bae5f/45ae.png 400w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/14be6/45ae.png 800w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/1b35a/45ae.png 1200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/89b0a/45ae.png 1490w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>dotenvissä määritellyt ympäristömuuttujat otetaan koodissa käyttöön komennolla\n<em>require('dotenv').config()</em> ja niihin viitataan Nodessa kuten \"normaaleihin\" ympäristömuuttujiin syntaksilla <em>process.env.MONGODB_URI</em>.</p>\n<p>Muutetaan nyt tiedostoa <i>index.js</i> seuraavasti</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ..</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>On tärkeää, että <i>dotenv</i> otetaan käyttöön ennen modelin <i>note</i> importtaamista, tällöin varmistutaan siitä, että tiedostossa <i>.env</i> olevat ympäristömuuttujat ovat alustettuja kun moduulin koodia importoidaan.</p>\n<h3>Muut operaatiot</h3>\n<p>Muutetaan nyt kaikki operaatiot tietokantaa käyttävään muotoon.</p>\n<p>Uuden muistiinpanon luominen tapahtuu seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    content<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    date<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>savedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Muistiinpano-oliot siis luodaan <em>Note</em>-konstruktorifunktiolla. Pyyntöön vastataan <em>save</em>-operaation takaisinkutsufunktion sisällä. Näin varmistutaan, että operaation vastaus tapahtuu vain jos operaatio on onnistunut. Palaamme virheiden käsittelyyn myöhemmin.</p>\n<p>Takaisinkutsufunktion parametrina oleva <em>savedNote</em> on talletettu muistiinpano. HTTP-pyyntöön palautetaan kuitenkin siitä metodilla <em>toJSON</em>formatoitu muoto:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Yksittäisen muistiinpanon tarkastelu muuttuu muotoon</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Frontendin ja backendin yhteistoiminnallisuuden varmistaminen</h3>\n<p>Kun backendia laajennetaan, kannattaa sitä testailla aluksi <strong>ehdottomasti selaimella, postmanilla tai VS Coden REST clientillä</strong>. Seuraavassa kokeillaan uuden muistiinpanon luomista tietokannan käyttöönoton jälkeen:</p>\n<picture><img src=\"/static/fedf336aae9e573fbfa4fe03f6f407e1/14be6/46e.png\" srcset=\"/static/fedf336aae9e573fbfa4fe03f6f407e1/4cce7/46e.png 200w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/bae5f/46e.png 400w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/14be6/46e.png 800w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/1b35a/46e.png 1200w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/9ee03/46e.png 1600w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/f0d76/46e.png 1902w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Vasta kun kaikki on todettu toimivaksi, kannattaa siirtyä testailemaan, että muutosten jälkeinen backend toimii yhdessä myös frontendin kanssa. Kaikkien kokeilujen tekeminen ainoastaan frontendin kautta on todennäköisesti varsin tehotonta.</p>\n<p>Todennäköisesti voi olla kannattavaa edetä frontin ja backin integroinnissa toiminnallisuus kerrallaan, eli ensin voidaan toteuttaa esim. kaikkien muistiinpanojen näyttäminen backendiin ja testata että toiminnallisuus toimii selaimella. Tämän jälkeen varmistetaan, että frontend toimii yhteen muutetun backendin kanssa. Kun kaikki on todettu olevan kunnossa, siirrytään seuraavan ominaisuuden toteuttamiseen.</p>\n<p>Kun kuvioissa on mukana tietokanta, on tietokannan tilan tarkastelu MongoDB Atlasin hallintanäkymästä varsin hyödyllistä, usein myös suoraan tietokantaa käyttävät Node-apuohjelmat, kuten tiedostoon <i>mongo.js</i> kirjoittamamme koodi auttavat sovelluskehityksen edetessä.</p>\n<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstackopen-2019/part3-notes-backend/tree/part3-3\">Githubissa</a>, branchissa <i>part3-3</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtäviä</h3>\n<p>Seuraavat tehtävät saattavat olla melko suoraviivaisia, tosin jos frontend-koodissasi sattuu olemaan bugeja tai epäyhteensopivuutta backendin kanssa, voi seurauksena olla myös mielenkiintoisia bugeja.</p>\n<h4>3.13: puhelinluettelo ja tietokanta, step1</h4>\n<p>Muuta backendin kaikkien puhelintietojen näyttämistä siten, että se <i>hakee näytettävät puhelintiedot tietokannasta</i>.</p>\n<p>Varmista, että frontend toimii muutosten jälkeen.</p>\n<p>Tee tässä ja seuraavissa tehtävissä Mongoose-spesifinen koodi omaan moduuliin samaan tapaan kuin luvussa <a href=\"/osa3/tietojen_tallettaminen_mongo_db_tietokantaan#tietokantamaarittelyjen-eriyttaminen-moduuliksi\">Tietokantamäärittelyjen eriyttäminen moduuliksi</a>.</p>\n<h4>3.14: puhelinluettelo ja tietokanta, step2</h4>\n<p>Muuta backendiä siten, että uudet numerot <i>tallennetaan tietokantaan</i>.\nVarmista, että frontend toimii muutosten jälkeen.</p>\n<p><i><strong>Tässä vaiheessa voit olla välittämättä siitä, onko tietokannassa jo henkilöä jolla on sama nimi kuin lisättävällä.</strong></i></p>\n</div>\n<div class=\"content\">\n<h3>Virheiden käsittely</h3>\n<p>Jos yritämme mennä selaimella sellaisen yksittäisen muistiinpanon sivulle, jota ei ole olemassa, eli esim. urliin <a href=\"http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431\">http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431</a> missä <i>5a3b80015b6ec6f1bdf68d</i> ei ole minkään tietokannassa olevan muistiinpanon tunniste, jää selain \"jumiin\" sillä palvelin ei vastaa pyyntöön koskaan.</p>\n<p>Palvelimen konsolissa näkyykin virheilmoitus:</p>\n<picture><img src=\"/static/2ff15d902e1f6e334988358da8d972ee/14be6/47.png\" srcset=\"/static/2ff15d902e1f6e334988358da8d972ee/4cce7/47.png 200w,\n/static/2ff15d902e1f6e334988358da8d972ee/bae5f/47.png 400w,\n/static/2ff15d902e1f6e334988358da8d972ee/14be6/47.png 800w,\n/static/2ff15d902e1f6e334988358da8d972ee/1b35a/47.png 1200w,\n/static/2ff15d902e1f6e334988358da8d972ee/9ee03/47.png 1600w,\n/static/2ff15d902e1f6e334988358da8d972ee/beddc/47.png 1610w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Kysely on epäonnistunut ja kyselyä vastaava promise mennyt tilaan <i>rejected</i>. Koska emme käsittele promisen epäonnistumista, ei pyyntöön vastata koskaan. Osassa 2 tutustuimme jo <a href=\"/osa2/palvelimella_olevan_datan_muokkaaminen#promise-ja-virheet\">promisejen virhetilanteiden käsittelyyn</a>.</p>\n<p>Lisätään tilanteeseen yksinkertainen virheidenkäsittelijä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kaikissa virheeseen päättyvissä tilanteissa HTTP-pyyntöön vastataan statuskoodilla 404 not found. Konsoliin tulostetaan tarkempi tieto virheestä.</p>\n<p>Tapauksessamme on itseasiassa olemassa kaksi erityyppistä virhetilannetta. Toinen vastaa sitä, että yritetään hakea muistiinpanoa virheellisen muotoisella <em>id</em>:llä, eli sellaisella mikä ei vastaa mongon id:iden muotoa.</p>\n<p>Jos teemme näin tulostuu konsoliin:</p>\n<pre>\nMethod: GET\nPath:   /api/notes/5a3b7c3c31d61cb9f8a0343\nBody:   {}\n---\n{ CastError: Cast to ObjectId failed for value \"5a3b7c3c31d61cb9f8a0343\" at path \"_id\"\n    at CastError (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/error/cast.js:27:11)\n    at ObjectId.cast (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/schema/objectid.js:158:13)\n    ...\n</pre>\n<p>Toinen virhetilanne taas vastaa tilannetta, missä haettavan muistiinpanon id on periaatteessa oikeassa formaatissa, mutta tietokannasta ei löydy indeksillä mitään:</p>\n<pre>\nMethod: GET\nPath:   /api/notes/5a3b7c3c31d61cbd9f8a0343\nBody:   {}\n---\nTypeError: Cannot read property 'toJSON' of null\n    at Note.findById.then.note (/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/index.js:27:24)\n    at process._tickCallback (internal/process/next_tick.js:178:7)\n</pre>\n<p>Nämä tilanteet on syytä erottaa toisistaan, ja itseasiassa jälkimmäinen poikkeus on oman koodimme aiheuttama.</p>\n<p>Muutetaan koodia seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> </span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Jos kannasta ei löydy haettua olioa, muuttujan <em>note</em> arvo on <em>undefined</em> ja koodi ajautuu <em>else</em>-haaraan. Siellä vastataan kyselyyn <i>404 not found_</i></p>\n<p>Jos id ei ole hyväksyttävässä muodossa, ajaudutaan <em>catch</em>:in avulla määriteltyyn virheidenkäsittelijään. Sopiva statuskoodi on <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1\">400 bad request</a> koska kyse on juuri siitä:</p>\n<blockquote>\n<p><i>The request could not be understood by the server due to malformed syntax. The client SHOULD NOT repeat the request without modifications.</i></p>\n</blockquote>\n<p>Vastaukseen on lisätty myös hieman dataa kertomaan virheen syystä.</p>\n<p>Promisejen yhteydessä kannattaa melkeinpä aina lisätä koodiin myös virhetilainteiden käsittely, muuten seurauksena on usein hämmentäviä vikoja.</p>\n<p>Ei ole koskaan huono idea tulostaa poikkeuksen aiheuttanutta olioa konsoliin virheenkäsittelijässä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Virheenkäsittelijään joutumisen syy voi olla joku ihan muu kuin mitä on tullut alunperin ajatelleeksi. Jos virheen tulostaa konsoliin, voi säästyä pitkiltä ja turhauttavilta väärää asiaa debuggaavilta sessioilta.</p>\n<p>Aina kun ohjelmoit ja projektissa on mukana backend <i><strong>tulee ehdottomasti koko ajan pitää silmällä backendin konsolin tulostuksia</strong></i>. Jos työskentelet pienellä näytöllä, riittää että konsolista on näkyvissä edes pieni kaistale:</p>\n<picture><img src=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/14be6/15b.png\" srcset=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/4cce7/15b.png 200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/bae5f/15b.png 400w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/14be6/15b.png 800w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/1b35a/15b.png 1200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/9ee03/15b.png 1600w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/5f626/15b.png 2050w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Virheidenkäsittelyn keskittäminen middlewareen</h3>\n<p>Olemme kirjoittaneet poikkeuksen aiheuttavan virhetilanteen käsittelevän koodin muun koodin sekaan. Se on välillä ihan toimiva ratkaisu, mutta on myös tilanteita, joissa on järkevämpää keskittää virheiden käsittely yhteen paikkaan. Tästä on huomattava etu esim. jos virhetilanteiden yhteydessä virheen aiheuttaneen pyynnön tiedot logataan tai lähetetään johonkin virhediagnostiikkajärjestelmään, esim. <a href=\"https://sentry.io/welcome/\">Sentryyn</a>. </p>\n<p>Muutetaan routen <i>/api/notes/:id</i> käsittelijää siten, että se <i>siirtää virhetilanteen käsittelyn eteenpäin</i> funktiolla <em>next</em>, jonka se saa <i>kolmantena</i> parametrina:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>note <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Eteenpäin siirrettävä virhe annetaan funktiolle <em>next</em> parametrina. Jos funktiota <em>next</em> kutsuttaisiin ilman parametria, käsittely siirtyisi ainoastaan eteenpäin seuraavaksi määritellylle routelle tai middlewarelle. Jos funktion <em>next</em> kutsussa annetaan parametri, siirtyy käsittely <i>virheidenkäsittelymiddlewarelle</i>.</p>\n<p>Expressin <a href=\"https://expressjs.com/en/guide/error-handling.html\">virheidenkäsittelijät</a> ovat middlewareja, joiden määrittelevällä funktiolla on <i>neljä parametria</i>. Virheidenkäsittelijämme näyttää seuraavalta:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span> <span class=\"token operator\">&amp;&amp;</span> error<span class=\"token punctuation\">.</span>kind <span class=\"token operator\">==</span> <span class=\"token string\">'ObjectId'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> \n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Virhekäsittelijä tarkastaa onko kyse <i>CastError</i>-poikkeuksesta, eli virheellisestä olioid:stä, jos on, se lähettää pyynnön tehneelle selaimelle vastauksen käsittelijän parametrina olevan response-olion avulla. Muussa tapauksessa se siirtää funktiolla <em>next</em> virheen käsittelyn Expressin oletusarvoisen virheidenkäsittelijän hoidettavavksi.</p>\n<h3>Middlewarejen käyttöönottojärjestys</h3>\n<p>Koska middlewaret suoritetaan siinä järjestyksessä, missä ne on otettu käyttöön funktiolla <em>app.use</em> on niiden määrittelyn kanssa oltava tarkkana.</p>\n<p>Oikeaoppinen järjestys seuraavassa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token keyword\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// olemattomien osoitteiden käsittely</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// virheellisten pyyntöjen käsittely</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p><em>bodyParser</em> on syytä ottaa käyttöön melkeimpä ensimmäisenä. Jos järjestys olisi seuraava</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span> <span class=\"token comment\">// request.body on tyhjä</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// request.body on tyhjä</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ei HTTP-pyynnön mukana oleva data olisi loggerin eikä POST-pyynnön käsittelyn aikana käytettävissä, kentässä <em>request.body</em> olisi tyhjä olio.</p>\n<p>Tärkeää on myös ottaa käyttöön olemattomien osoitteiden käsittely viimeisenä.</p>\n<p>Myös seuraava järjestys aiheuttaisi ongelman</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// olemattomien osoitteiden käsittely</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Nyt olemattomien osoitteiden käsittely on sijoitettu <i>ennen HTTP GET -pyynnön käsittelyä</i>. Koska olemattomien osoitteiden käsittelijä vastaa kaikkiin pyyntöihin <i>404 unknown endpoint</i>, ei mihinkään sen jälkeen määriteltyyn reittiin tai middlewareen (poikkeuksena virheenkäsittelijä) enää mennä. </p>\n<h3>Muut operaatiot</h3>\n<p>Toteutetaan vielä jäljellä olevat operaatiot, eli yksittäisen muistiinpanon poisto ja muokkaus.</p>\n<p>Poisto onnistuu helpoiten metodilla <a href=\"https://mongoosejs.com/docs/api.html#model_Model.findByIdAndRemove\">findByIdAndRemove</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndRemove</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">204</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Vastauksena on statauskoodi <i>204 no content</i> molemmissa \"onnistuneissa\" tapauksissa, eli jos olio poistettiin tai olioa ei ollut mutta <i>id</i> oli periaatteessa oikea. Takaisinkutsun parametrin <em>result</em> perusteella olisi mahdollisuus haarautua ja palauttaa tilanteissa eri statuskoodi, jos sille on tarvetta. Mahdollinen poikkeus siirretään jälleen virheenkäsittelijälle.</p>\n<p>Muistiinpanon tärkeyden muuttamisen mahdollistava olemassaolevan muistiinpanon päivitys onnistuu helposti metodilla <a href=\"https://mongoosejs.com/docs/api.html#model_Model.findByIdAndUpdate\">findByIdAndUpdate</a>. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    content<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token punctuation\">:</span> body<span class=\"token punctuation\">.</span>important<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndUpdate</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>updatedNote <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>updatedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Operaatio mahdollistaa myös muistiinpanon sisällön editoinnin. Päivämäärän muuttaminen ei ole mahdollista.</p>\n<p>Huomaa, että metodin <em>findByIdAndUpdate</em> parametrina tulee antaa normaali Javascript-olio, eikä uuden olion luomisessa käytettävä <em>Note</em>-konstruktorifunktiolla luotu olio.</p>\n<p>Pieni, mutta tärkeä detalji liittyen operaatioon <em>findByIdAndUpdate</em>. Oletusarvoisesti tapahtumankäsittelijä saa parametrikseen <em>updatedNote</em> päivitetyn olion <a href=\"https://mongoosejs.com/docs/api.html#model_Model.findByIdAndUpdate\">ennen muutosta</a> olleen tilan. Lisäsimme operaatioon parametrin <code>{ new: true }</code>, jotta saamme muuttuneen olion palautetuksi kutsujalle.</p>\n<p>Backend vaikuttaa toimivan postmanista ja VS Coden REST-clientistä tehtyjen kokeilujen perusteella, ja myös frontend toimii moitteettomasti tietokantaa käyttävän backendin kanssa.</p>\n<p>Kun muutamme muistiinpanon tärkeyttä, tulostuu backendin konsoliin ikävä varoitus</p>\n<picture><img src=\"/static/33dc22598d76bd2f99a715761f13607f/14be6/48.png\" srcset=\"/static/33dc22598d76bd2f99a715761f13607f/4cce7/48.png 200w,\n/static/33dc22598d76bd2f99a715761f13607f/bae5f/48.png 400w,\n/static/33dc22598d76bd2f99a715761f13607f/14be6/48.png 800w,\n/static/33dc22598d76bd2f99a715761f13607f/1b35a/48.png 1200w,\n/static/33dc22598d76bd2f99a715761f13607f/9ee03/48.png 1600w,\n/static/33dc22598d76bd2f99a715761f13607f/a3b7c/48.png 1602w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Googlaamalla virheilmoitusta löytyy <a href=\"https://stackoverflow.com/questions/52572852/deprecationwarning-collection-findandmodify-is-deprecated-use-findoneandupdate\">ohje</a> ongelman korjaamiseen. Eli kuten <a href=\"https://mongoosejs.com/docs/deprecations.html\">mongoosen dokumentaatio kehottaa</a> lisätään tiedostoon <i>note.js</i> yksi rivi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">mongoose<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'useFindAndModify'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ...</span>\n  \nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span> </code></pre></div>\n<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstackopen-2019/part3-notes-backend/tree/part3-4\">githubissa</a>, branchissa <i>part3-4</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtäviä</h3>\n<h4>3.15: puhelinluettelo ja tietokanta, step3</h4>\n<p>Muuta backendiä siten, että numerotietojen poistaminen päivittyy tietokantaan.</p>\n<p>Varmista, että frontend toimii muutosten jälkeen.</p>\n<h4>3.16: puhelinluettelo ja tietokanta, step4</h4>\n<p>Keskitä sovelluksen virheidenkäsittely middlewareen.</p>\n<h4>3.17*: puhelinluettelo ja tietokanta, step5</h4>\n<p>Jos frontendissä annetaan numero henkilölle, joka on jo olemassa, päivittää frontend tehtävässä 2.18 tehdyn toteutuksen ansiosta tiedot uudella numerolla tekemällä HTTP PUT -pyynnön henkilön tietoja vastaavaan url:iin.</p>\n<p>Laajenna backendisi käsittelemään tämä tilanne.</p>\n<p>Varmista, että frontend toimii muutosten jälkeen.</p>\n<h4>3.18*: puhelinluettelo ja tietokanta, step6</h4>\n<p>Päivitä myös polkujen <i>api/persons/:id</i> ja <i>info</i> käsittely, ja varmista niiden toimivuus suoraan selaimella, postmanilla tai VS Coden REST clientillä.</p>\n<p>Selaimella tarkastellen yksittäisen numerotiedon tulisi näyttää seuraavalta:</p>\n<picture><img src=\"/static/853a1d57372a2b5c8fc1249b682d59a7/14be6/49.png\" srcset=\"/static/853a1d57372a2b5c8fc1249b682d59a7/4cce7/49.png 200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/bae5f/49.png 400w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/14be6/49.png 800w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/1b35a/49.png 1200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/f0a3f/49.png 1586w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/part-3-8ac7bc0fb2b7018a7853b00c454b2103.svg"},"part":3,"letter":"c","lang":"fi"}}},"pageContext":{"part":3,"letter":"c","lang":"fi"}}
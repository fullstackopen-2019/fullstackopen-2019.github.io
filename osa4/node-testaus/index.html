<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/3.a72d220d261fcaebbeef.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);.arrow__container{position:relative}.arrow__container:not():first-child{border-left:none}.arrow__container:not():first-child:before{content:"";background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NzcuMTc1IDQ3Ny4xNzUiPjxwYXRoIGQ9Ik0zNjAuNzMxIDIyOS4wNzVsLTIyNS4xLTIyNS4xYy01LjMtNS4zLTEzLjgtNS4zLTE5LjEgMHMtNS4zIDEzLjggMCAxOS4xbDIxNS41IDIxNS41LTIxNS41IDIxNS41Yy01LjMgNS4zLTUuMyAxMy44IDAgMTkuMSAyLjYgMi42IDYuMSA0IDkuNSA0IDMuNCAwIDYuOS0xLjMgOS41LTRsMjI1LjEtMjI1LjFjNS4zLTUuMiA1LjMtMTMuOC4xLTE5eiIvPjwvc3ZnPg==) no-repeat;background-size:contain;position:absolute;top:0;left:0;height:100%;width:100%}.arrows--horizontal{display:flex;position:relative;margin:0;align-items:flex-start}.arrow__wrapper{display:flex;justify-content:flex-start;align-items:center;margin:0}.arrow__wrapper:first-of-type{border-right:none;z-index:20}.arrow__wrapper:nth-of-type(n+2){margin-left:-4rem;z-index:10}.arrow__wrapper:nth-of-type(n+2) .arrow__rectangle{border-left:none;padding-left:4rem}.arrow__wrapper:nth-of-type(3){z-index:5}.arrow__rectangle{padding:1rem;justify-content:center;align-items:center;border:2px solid #33332d;border-right:none;z-index:2;overflow:hidden}.arrow__rectangle .bold{font-weight:600}.arrow__rectangle--thick-border{border:3px solid #33332d;border-right:none}.arrow__point{padding:1.25rem;border:2px solid #33332d;border-bottom:none;border-left:none;-webkit-transform:translate(-1.3rem) rotate(45deg);transform:translate(-1.3rem) rotate(45deg);z-index:1;overflow:hidden}.arrow__point--thick-border{border:3px solid #33332d;border-bottom:none;border-left:none}.arrow__wrapper--stacked{display:flex;justify-content:flex-start;align-items:center;margin:auto auto auto 0}.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:-2px}.arrow--stacked-letter{margin-right:2rem}.arrow--stacked-title{text-transform:uppercase;white-space:nowrap}.element--flex{display:flex;flex-wrap:wrap}.element--space-around{justify-content:space-around}.element--space-between{justify-content:space-between}.element--column{flex-direction:column}.element--centered{align-items:center}.element--horizontal-half{width:45%}.element--auto-bottom-margin{margin-bottom:auto}.element--flex-start{align-content:flex-start}.banner{display:flex;align-items:center;position:relative;padding:2.22rem 0;background-color:#e1e1e1}@media (min-width:992px){.banner{padding:3.444rem 3.444rem 4.444rem}}html{font-family:IBM Plex Mono,monospace;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:IBM Plex Mono,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em IBM Plex Mono,monospace;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:IBM Plex Mono,monospace;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}body,html{margin:0;padding:0;font-family:IBM Plex Mono,monospace;font-weight:500;color:#33332d;font-size:14px;line-height:1.555rem}@media (min-width:992px){body,html{font-size:18px}}body{padding-top:120px}@media (min-width:992px){body{padding-top:90px}}p{margin:0;text-align:left;line-height:1.5em}a,p{color:#33332d}a{text-decoration:none}.container{position:relative;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;width:90%;max-width:1200px}.hidden{display:none!important}.centered{text-align:center}.spacing{margin-top:2.22rem}@media (min-width:992px){.spacing{margin-top:5.55rem}}.spacing--small{margin-top:1.11rem}@media (min-width:992px){.spacing--small{margin-top:3.444rem}}.spacing--large{margin-top:4.44rem}@media (min-width:992px){.spacing--large{margin-top:11.1rem}}.spacing--extra-large{margin-top:4.44rem}@media (min-width:992px){.spacing--extra-large{margin-top:22.2rem}}.spacing--after{margin-bottom:2.22rem}@media (min-width:992px){.spacing--after{margin-bottom:5.55rem}}.spacing--after-small{margin-bottom:1.11rem}@media (min-width:992px){.spacing--after-small{margin-bottom:2.775rem}}.spacing--after-large{margin-bottom:4.44rem}@media (min-width:992px){.spacing--after-large{margin-bottom:11.1rem}}@media (max-width:991px){.spacing--mobile{margin-top:2.22rem}}.col-1{width:100%}@media (min-width:992px){.col-1{width:10%}}.col-2{width:100%}@media (min-width:992px){.col-2{width:20%}}.col-3{width:100%}@media (min-width:992px){.col-3{width:30%}}.col-4{width:100%}@media (min-width:992px){.col-4{width:40%}}.col-5{width:100%}@media (min-width:992px){.col-5{width:50%}}.col-6{width:100%}@media (min-width:992px){.col-6{width:60%}}.col-7{width:100%}@media (min-width:992px){.col-7{width:70%}}.col-8{width:100%}@media (min-width:992px){.col-8{width:80%}}.col-9{width:100%}@media (min-width:992px){.col-9{width:90%}}.col-10{width:100%}@media (min-width:992px){.col-10{width:100%}}@media (min-width:992px){.push-right-1{margin-left:10%}.push-right-2{margin-left:20%}.push-right-3{margin-left:30%}.push-right-4{margin-left:40%}.push-right-5{margin-left:50%}.push-left-1{margin-right:10%}.push-left-2{margin-right:20%}.push-left-3{margin-right:30%}.push-left-4{margin-right:40%}.push-left-5{margin-right:50%}.push-left{margin-right:auto}.push-right{margin-left:auto}}@media (max-width:991px){.col-5--mobile{width:50%}.col-10--mobile{width:100%}.order-0--mobile{order:0}.order-1--mobile{order:1}.order-2--mobile{order:2}.order-3--mobile{order:3}.order-4--mobile{order:4}.order-5--mobile{order:5}.hidden--mobile{display:none}}.centered-vertically{display:flex;flex-direction:column;justify-content:center}.nav-item-hover{font-size:1.111rem;font-weight:600;text-decoration:none;color:#33332d;padding:.2em}.nav-item-hover:active,.nav-item-hover:focus,.nav-item-hover:hover{color:#fff;background-color:#33332d}.nav-item-hover:active,.nav-item-hover:focus{outline:2px solid #706be4}.flex-fix-aligning:after,.flex-fix-aligning:before{content:"";width:30%;order:2}.triple-border{margin:5px;position:relative;padding:2px;border-radius:5px 0;transition:color .1s ease-in-out,background-color .1s ease-in-out}.triple-border:after,.triple-border:before{content:"";border:2px solid #33332d;border-radius:5px;position:absolute;width:calc(100% + 5px);height:calc(100% + 5px)}.triple-border:before{left:0;top:0}.triple-border:after{bottom:0;right:0}.triple-border__container{overflow:hidden;border-radius:3px 0}.triple-border--large-margin{margin:13px;padding:3px}.triple-border--large-margin:after,.triple-border--large-margin:before{content:"";border-width:3px;border-radius:13px;width:calc(100% + 13px);height:calc(100% + 13px)}.triple-border--large-margin .triple-border__container{border-radius:10px 0}.triple-border__logo{padding:.2rem;font-size:1.111rem;font-weight:600}.triple-border__return-tasks{font-size:.9rem;padding:1rem .2rem}.body-text:not(:last-of-type){margin-bottom:2.775rem}.body-text__title{color:#33332d;font-size:1.44rem;line-height:1.25em;font-weight:700;margin:0;position:relative;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.body-text__content:not(:last-of-type){padding-bottom:2em}.bold{font-weight:700}.body-text--no-padding{padding:0!important}.sub-header{color:#33332d;font-family:IBM Plex Mono,monospace;padding-bottom:1.357rem}@media (min-width:992px){.sub-header{padding-bottom:2.333rem}}</style><style data-href="/component---src-templates-content-template-js.f8de6730a2b187ff23d1.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);.course{position:relative}.course h1,.course h2,.course h3,.course h4,.course p{margin-left:3rem;padding-bottom:2rem}.course pre{margin:2rem 0;background-color:#33332d;color:#fff}.course img{border:11px solid transparent}.course a{border:0;border-bottom:2px;border-style:solid;border-color:transparent;padding:2px}.course .banner,.course .container{position:static}.course .letter{width:4rem;height:4rem;border-width:5px;border-style:solid;border-radius:2.5rem;text-align:center;margin:1rem;line-height:.8em}@media (min-width:640px){.course .letter{-webkit-transform:translate(-3rem,5rem);transform:translate(-3rem,5rem)}}.course .letter,.course h1{font-size:3.444rem;font-weight:700}.course li{list-style-type:none}.course li:before{content:"-";margin-right:1rem}.scroll-navigation li:hover{cursor:pointer;background-color:#000;color:#fff}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link as="script" rel="preload" href="/app-67344562b5b49e175a68.js"/><link as="script" rel="preload" href="/component---src-templates-content-template-js-9ae9efce9693e864dafe.js"/><link as="script" rel="preload" href="/3-182d4ec591e98e4cb3cf.js"/><link as="script" rel="preload" href="/2-05b8e96bb38d89449454.js"/><link as="script" rel="preload" href="/webpack-runtime-001ae6790d0960433a57.js"/><link rel="preload" href="/static/d/986/path---osa-4-node-testaus-edb-c9b-jDfNcvYdOlz8CsXzSl8RlScqEw.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><div class="container" style="align-items:center"><a style="text-decoration:none" href="/"><div class="triple-border nav-item-hover " style="padding:0.2em"><div class="triple-border__container triple-border__logo" style="background-color:transparent">{() =&gt; fs}</div></div></a><div class="col-4 push-left-4" style="display:flex;justify-content:space-between;font-weight:bold"><a class="nav-item-hover" href="/about">KURSSISTA</a><a class="nav-item-hover" href="/faq">FAQs</a><a class="nav-item-hover" href="/companies">YRITYSESITTELYT</a></div></div><div class="spacing--small spacing--after"><div class="course-container"><div class="banner spacing--after" style="background-image:url(/static/osa5-8edc6044aad809a3143dc36c5e7f3b4c.png);background-position:center center;background-size:80%;background-repeat:no-repeat;background-color:#F7F382"><div class="container"><div class="col-10 spacing spacing--after"><div class="arrow__container arrows--horizontal"><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:#F7F382;color:black">YLEISTÄ</div><div class="arrow__point " style="background-color:#F7F382;color:black"></div></div><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:#F7F382;color:black">OSA 4 YLEISTÄ</div><div class="arrow__point " style="background-color:#F7F382;color:black"></div></div><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:black;color:white">NODE.JS -SOVELLUSTEN TESTAUS</div><div class="arrow__point " style="background-color:black;color:white"></div></div></div></div></div></div><div class="course"><div class="container"><div class="col-7 course-content push-right-3" style="border-color:#F7F382"><p class="col-1 letter" style="border-color:#F7F382">b</p><h1 class="sub-header ">Node.js -sovellusten testaus</h1></div></div><div class="container"><div class="scroll-navigation col-3 element--flex element--column"></div><div class="course-content col-7">
<h3>Testejä ja backendin refaktorointia</h3>
<p>Koodia refaktoroidessa vaanii aina <a href="https://en.wikipedia.org/wiki/Regression_testing">regression</a> vaara, eli on olemassa riski, että jo toimineet ominaisuudet hajoavat. Tehdäänkin muiden operaatioiden refaktorointi siten, että ennen koodin muutosta tehdään jokaiselle API:n routelle sen toiminnallisuuden varmistavat testit.</p>
<p>Aloitetaan lisäysoperaatiosta. Tehdään testi, joka lisää uuden muistiinpanon ja tarkistaa, että API:n palauttamien muistiinpanojen määrä kasvaa, ja että lisätty muistiinpano on palautettujen joukossa:</p>
<pre><code class="language-js">test(&#x27;a valid note can be added &#x27;, async () =&gt; {
  const newNote = {
    content: &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;,
    important: true,
  };

  await api
    .post(&#x27;/api/notes&#x27;)
    .send(newNote)
    .expect(200)
    .expect(&#x27;Content-Type&#x27;, /application\/json/);

  const response = await api.get(&#x27;/api/notes&#x27;);

  const contents = response.body.map(r =&gt; r.content);

  expect(response.body.length).toBe(initialNotes.length + 1);
  expect(contents).toContain(
    &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;
  );
});
</code></pre>
<p>Kuten odotimme ja toivoimme, menee testi läpi.</p>
<p>Tehdään myös testi, joka varmistaa, että muistiinpanoa, jolle ei ole asetettu sisältöä, ei talleteta</p>
<pre><code class="language-js">test(&#x27;note without content is not added &#x27;, async () =&gt; {
  const newNote = {
    important: true,
  };

  const initialNotes = await api.get(&#x27;/api/notes&#x27;);

  await api
    .post(&#x27;/api/notes&#x27;)
    .send(newNote)
    .expect(400);

  const response = await api.get(&#x27;/api/notes&#x27;);

  expect(response.body.length).toBe(initialNotes.length);
});
</code></pre>
<p>Testi ei mene läpi.</p>
<p>Käy ilmi, että myös operaation suoritus postman tai Visual Studio Coden REST clientillä johtaa virhetilanteeseen. Koodissa on siis bugi.</p>
<blockquote>
<p><strong>Huom:</strong> testejä tehdessä täytyy aina varmistua siitä, että testi testaa oikeaa asiaa, ja usein ensimmäistä kertaa testiä tehdessä se että testi ei mene läpi tarkoittaa sitä, että testi on tehty väärin. Myös päinvastaista tapahtuu, eli testi menee läpi mutta koodissa onkin virhe, eli testi ei testaa sitä mitä sen piti testata. Tämän takia testit kannattaa aina &quot;testata&quot; rikkomalla koodi ja varmistamalla, että testi huomaa koodiin tehdyt virheet.</p>
</blockquote>
<p>Kun suoritamme operaation postmanilla konsoli paljastaa, että kyseessä on <em>Unhandled promise rejection</em>, eli koodi ei käsittele promisen virhetilannetta:</p>
<pre>

Server running on port 3001
Method: POST
Path:   /api/notes/
Body:   { important: true }
---
(node:28657) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: Can&#x27;t set headers after they are sent.
(node:28657) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.
</pre>
<p>Kuten jo edellisessä osassa mainittiin, tämä ei ole hyvä idea. Kannattaakin aloittaa lisäämällä promise-ketjuun metodilla <em>catch</em> virheenkäsittelijä, joka tulostaa konsoliin virheen syyn:</p>
<pre><code class="language-js">notesRouter.post(&#x27;/&#x27;, (request, response) =&gt; {
  // ...

  note
    .save()
    .then(note =&gt; {
      return formatNote(note)
    })
    .then(formattedNote =&gt; {
      response.json(formattedNote)
    })
    .catch(error =&gt; {
      console.log(error)
      response.status(500).json({ error: &#x27;something went wrong...&#x27; })
    })
</code></pre>
<p>Konsoliin tulostuu seuraava virheilmoitus</p>
<pre>

Error: Can&#x27;t set headers after they are sent.
    at validateHeader (_http_outgoing.js:489:11)
    at ServerResponse.setHeader (_http_outgoing.js:496:3)
</pre>
<p>Aloittelijalle virheilmoitus ei välttämättä kerro paljoa, mutta googlaamalla virheilmoituksella, pieni etsiminen tuottaisi jo tuloksen.</p>
<p>Kyse on siitä, että koodi kutsuu <em>response</em>-olion metodia <em>send</em> kaksi kertaa, tai oikeastaan koodi kutsuu metodia <em>json</em>, joka kutsuu edelleen metodia <em>send</em>.</p>
<p>Kaksi kertaa tapahtuva <em>send</em>-kutsu johtuu siitä, että koodin alun <em>if</em>-lauseessa on ongelma:</p>
<pre><code class="language-js">notesRouter.post(&#x27;/&#x27;, (request, response) =&gt; {
  const body = request.body

  if (body.content === undefined) {
    response.status(400).json({ error: &#x27;content missing&#x27; })
    // suoritus jatkuu!
  }

  //...
}
</code></pre>
<p>kun koodi kutsuu <code>response.status(400).json(...)</code> suoritus jatkaa koodin alla olevaa osaan ja se taas aiheuttaa uuden <code>response.json()</code>-kutsun.</p>
<p>Korjataan ongelma lisäämällä <em>if</em>-lauseeseen <em>return</em>:</p>
<pre><code class="language-js">notesRouter.post(&#x27;/&#x27;, (request, response) =&gt; {
  const body = request.body

  if (body.content === undefined) {
    return response.status(400).json({ error: &#x27;content missing&#x27; })
  }

  //...
}
</code></pre>
<p>Edellisen osan lopussa koodi oli vielä oikein, mutta siirtäessämme osan alussa koodia tiedostosta <em>index.js</em> uuteen paikkaan, on <em>return</em> kadonnut matkalta.</p>
<p>Promiseja käyttävä koodi toimii nyt ja testitkin menevät läpi. Olemme valmiit muuttamaan koodin käyttämään async/await-syntaksia.</p>
<p>Koodi muuttuu seuraavasti (huomaa, että käsittelijän alkuun on laitettava määre <em>async</em>):</p>
<pre><code class="language-js">notesRouter.post(&#x27;/&#x27;, async (request, response) =&gt; {
  const body = request.body;

  if (body.content === undefined) {
    return response.status(400).json({ error: &#x27;content missing&#x27; });
  }

  const note = new Note({
    content: body.content,
    important: body.important === undefined ? false : body.important,
    date: new Date(),
  });

  const savedNote = await note.save();
  response.json(formatNote(savedNote));
});
</code></pre>
<p>Koodiin jää kuitenkin pieni ongelma: virhetilanteita ei nyt käsitellä ollenkaan. Miten niiden suhteen tulisi toimia?</p>
</div></div></div><div class="container spacing element--flex element--column element--centered"><div class="body-text "><p class="body-text__content bold">Tehtävien palautus</p></div><a href="https://studies.cs.helsinki.fi/fullstackopen/" style="padding:1rem 0" class="col-2 centered spacing--small"><div class="triple-border  triple-border--large-margin" style="padding:"><div class="triple-border__container triple-border__return-tasks" style="background-color:transparent">Palauta tehtävät palautussovellukseen</div></div></a></div><div class="container spacing spacing--after-large "><a class="push-right-1" href="/osa3"><div class=" element--flex element--column"><p style="text-align:right">Osa <!-- -->3</p><b>Edellinen osa</b></div></a><a class="push-left-1" href="/osa5"><div class=" element--flex element--column"><p>Osa <!-- -->5</p><b>Seuraava osa</b></div></a></div></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-content-template-js","jsonName":"osa-4-node-testaus-edb","path":"/osa4/node-testaus"};window.dataPath="986/path---osa-4-node-testaus-edb-c9b-jDfNcvYdOlz8CsXzSl8RlScqEw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-67344562b5b49e175a68.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-ca31b0051a8e3dd2ad89.js"],"component---src-templates-content-template-js":["/component---src-templates-content-template-js.f8de6730a2b187ff23d1.css","/component---src-templates-content-template-js-9ae9efce9693e864dafe.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6b2a052f583874595ff2.js"],"component---src-pages-about-js":["/component---src-pages-about-js.2ddee56b9aa16d898991.css","/component---src-pages-about-js-132e712eeb51f5ab814a.js"],"component---src-pages-companies-js":["/component---src-pages-companies-js-13135ae80c07b979aaba.js"],"component---src-pages-faq-js":["/component---src-pages-faq-js-951377a8152c7eba743a.js"],"component---src-pages-index-js":["/component---src-pages-index-js.1bd0162819a3d2fd4101.css","/component---src-pages-index-js-20c5bc1e054ac8202c48.js"],"component---src-pages-osa-0-js":["/component---src-pages-osa-0-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-0-js-e8583e681512e194ee63.js"],"component---src-pages-osa-1-js":["/component---src-pages-osa-1-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-1-js-180cdbb0fe22e9858e0c.js"],"component---src-pages-osa-2-js":["/component---src-pages-osa-2-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-2-js-e633a55711dad96c627c.js"],"component---src-pages-osa-3-js":["/component---src-pages-osa-3-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-3-js-67026fa702e31fb34609.js"],"component---src-pages-osa-4-js":["/component---src-pages-osa-4-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-4-js-aff7395481222f09bbe5.js"],"component---src-pages-osa-5-js":["/component---src-pages-osa-5-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-5-js-6a0065aaa49b1b893073.js"],"component---src-pages-osa-6-js":["/component---src-pages-osa-6-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-6-js-1aedbeff823795746154.js"],"component---src-pages-osa-7-js":["/component---src-pages-osa-7-js.f6351a2be0cea4d578bc.css","/component---src-pages-osa-7-js-9219f5d2e5d3b1480e06.js"]};/*]]>*/</script><script src="/webpack-runtime-001ae6790d0960433a57.js" async=""></script><script src="/2-05b8e96bb38d89449454.js" async=""></script><script src="/3-182d4ec591e98e4cb3cf.js" async=""></script><script src="/component---src-templates-content-template-js-9ae9efce9693e864dafe.js" async=""></script><script src="/app-67344562b5b49e175a68.js" async=""></script></body></html>